# ТЗ «Пропущенные намазы (Каза)»

Документ консолидирует требования, присланные 18.11.2025.

## 1. Цель

Рассчитать общий долг по обязательным намазам (включая витр по ханафитскому мазхабу) с момента булюга до текущей даты, учитывая женские периоды (хайд, нифас), а также дни путешествий (сафар). Дополнительно — отслеживание погашения, отчёты, AI рекомендации/мотиватор и интеграция с e-Replika API.

## 2. Мини-словарь

| Термин | Описание |
| --- | --- |
| Булюг | Наступление совершеннолетия. По умолчанию 15 лет (хиджра). |
| Хайд | Ежемесячный женский период, не требующий срока для молитв. |
| Ниас | Послеродовой период, по умолчанию 40 дней. |
| Сафар | Путешествие, когда допускается кыср-намаз. |
| Каза | Восполнение пропущенных обязательных намазов. |
| Витр | Обязательный (вāджиб) намаз в ханафитском мазхабе. |

Полный глоссарий подтягивается с e-Replika (эндпоинт `/glossary`).

## 3. Вводимые данные

- дата рождения, пол, количество детей, дата начала молитв или чекбокс «сегодня»;
- возраст булюга (по умолчанию 15, можно задать вручную);
- для женщин: длина цикла (хайд), количество родов, длительность нифаса;
- учёт дней путешествия: общее число + список периодов (дат);
- согласие на обработку данных, хранение только агрегатов.

## 4. Алгоритм (Ханафи v1.0.0)

1. `bulugh_date = convertToHijri(birth_date).addYears(bulugh_age);`
2. `period.start = bulugh_date; period.end = today` или `prayer_start_date`.
3. `total_days = floor((end - start)/86400000)` (ограничение 80 лет).
4. Исключения:
   - для женщин: `haid_days = total_days/30.44 * haid_days_per_month`;
   - `nifas_days = childbirth_count * nifas_days_per_childbirth`;
   - добавляем `total_travel_days` (c валидацией перекрытий).
5. `effective_days = total_days - excludedDays`;
6. Пропущенные намазы = `effective_days` по каждому из 5 обязательных + витр;
7. Сафар-намазы: `dhuhr_safar = total_travel_days` и аналогично аср/иша.

> Примечание: при выборе шафиитского мазхаба витр считается нафилью — он исключён из расчёта и прогресса.

## 5. API

| Метод | Путь | Описание |
| --- | --- | --- |
| `POST /api/prayer-debt/calculate` | Синхронный расчёт, возвращает snapshot `UserPrayerDebt`. Тело содержит `madhab` (`hanafi` \| `shafii`, опционально). |
| `GET /api/prayer-debt/snapshot` | Последний расчёт + текущий прогресс. |
| `PATCH /api/prayer-debt/progress` | Обновление выполненных намазов (`entries[]`). |
| `GET /api/prayer-debt/report.pdf` | Запрос PDF-отчёта. |
| `POST /api/prayer-debt/calculations` | Асинхронный расчёт (через e-Replika job). |
| `GET /api/prayer-debt/calculations/:job_id` | Статус job. |
| `POST /api/webhooks/prayer-debt` | Вебхук от e-Replika. |

### Валидация

- `prayer_start_date >= bulugh_date`;
- отсутствуют пересечения в `travel_periods`;
- `haid_days_per_month <= 15`;
- `total_days <= 80 * 365`;
- даты/диапазоны в UTC.

## 6. UI вкладки

1. **Расчёт долга** — форма ввода, кнопка «Рассчитать».
2. **Мой долг** — прогрессбар по каждому намазу + CTA отметки.
3. **Сафар-намазы** — отдельный прогресс по кыср намазам.
4. **План восполнения** — AI план + темп + ETA.
5. **Отчёты** — график пути, кнопки «PDF», «Поделиться».

## 7. AI функции

- `optimizeRepaymentSchedule` — анализ привычек + свободных слотов.
- `generateMotivationalMessage` — milestone + случайные хадисы/дуа.
- `detectMissedPrayerPatterns` — weekly trend, уведомления.

## 8. Интеграции

- Цели/привычки — авто-цель «Восполнить X за месяц».
- Календарь намазов — уведомления о каза-намазах.
- e-Replika API — рендер PDF, webhook, хранение расчётов.

## 9. Безопасность

- шифрование персональных данных (AES-256);
- согласие при первом входе;
- хранение агрегатов + AuditLog всех изменений;
- calc-version для обратной совместимости.

## 10. Расширение

- Ханафи — реализовано по умолчанию;
- Шафиитский — реализован, витр исключён при расчёте (`madhab=shafii`);
- Другие мазхабы — добавляются через параметр `madhab`.

## 11. Рекомендации

- Все даты в UTC, конвертируем только в UI.
- Использовать `umm-alqura-calendar` или e-Replika для Hijri.
- PDF генерируем централизованно через `/reports/pdf`.
- В UI добавить дисклеймер: «Расчёт по ханафитской методике, витр включён».


